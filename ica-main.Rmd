---
title: "Untitled"
output: github_document
always_allow_html: true

#Bhan, Lam (2022) [Nanyang Technological University]
#ORCID: 0000-0001-5193-6560
#GitHub: https://github.com/bhanlam/
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message=FALSE)

library(pander)
library(dataverse)
library(tibble)
library(readxl)
library(tidyr)
library(plyr)
library(dplyr)
library(stringr)
library(forcats)
library(skimr)
library(janitor)
library(rstatix)
library(ggpubr)
library(ggplot2)
library(RColorBrewer)
library(gridExtra)
library(grid)
```

This repository contains the code accompanying the publication "Do uHear? Validation of uHear App for Preliminary Screening of Hearing Ability in Soundscape Studies". This paper is hosted on [arXiv]() and the raw dataset is hosted at [10.21979/N9/0NE37R](https://doi.org/10.21979/N9/0NE37R).

## Environment

The code has been tested on the following platform.

```{r session, message=FALSE, echo=FALSE}
pander(sessionInfo())
```

## Data preparation

Load data from excel

```{r dataloader, message=FALSE}
#load data into dataframe
dataset <- tibble::as_tibble(read_excel("Hearing test result.xlsx",skip = 0))


#prepare data in dataframe for analysis
cols2fac <- colnames(dataset)[colnames(dataset)!="Age"]
facOrder <- c(seq(-10,70,5),"NaN") #order factors
cleandata <- dataset %>% 
        filter(complete.cases(.)) %>% #remove incomplete cases
        mutate_at(cols2fac,factor) %>% #convert variable to factor 
        mutate_at(cols2fac[5:15],~fct_relevel(.,facOrder))

#tidy data to wide form
widedata <- cleandata %>%
        pivot_wider(names_from=c(Type,Ear),values_from = c("0.125":"8"))

```

## Exploratory analysis

### Demographics

```{r demographics}
demo <- cleandata %>% #extract demographics only
        select(c("Participant ID","Gender","Age")) %>%
        distinct(`Participant ID`,.keep_all = TRUE)
skim(demo)
get_summary_stats(demo) #summary stats for age
demo %>% tabyl(Gender) #gender count w perc

#generate latex table

```
### Pure tone audiometry summary statistics

Summarize proportions across dB levels for each frequency

```{r ptaSummary}

t<-cleandata %>% 
        filter(Type=="Audiometer") %>%
        tabyl(`0.125`,Ear) %>%
        adorn_totals(where = "row") %>%             # add a total row
        adorn_percentages(denominator = "col") %>%  # convert to proportions
        adorn_pct_formatting() %>%                  # convert to percents
        adorn_ns(position = "front") %>%            # display as: "count (percent)"
        adorn_title(                                # adjust titles
        row_name = "125 Hz",
        col_name = "Ear")

```

### Test for normality

QQ plot, shapiro-wilks

```{r normality}
ggqqplot(tidydata %>% filter(freq=="6" && Ear=="Left") %>% .$diff)
gghistogram(tidydata %>% filter(freq=="6" && Ear=="Left") %>% .$diff,
            binwidth = 5,
            add.normal = TRUE)
shapiro.test(tidydata %>% filter(freq=="0.5" && Ear=="Left") %>% .$diff)

```


### Bland-Altman

Bland-Altman plots to visually compare differences between audiometer and mobile app

UHear
- 0.5 kHz
- 1 kHz
- 2 kHz
- 4 kHz
- 6 kHz

J. Martin Bland, D. Altman, STATISTICAL METHODS FOR ASSESSING AGREEMENT BETWEEN TWO METHODS OF CLINICAL MEASUREMENT, Lancet. 327 (1986) 307â€“310. https://doi.org/10.1016/S0140-6736(86)90837-8.

```{r blaalt}

uHfreq<-c("0.5","1","2","4","6")
defvar<-c("Participant ID","Gender","Age","Type","Ear")

#compute mean and difference for each frequency across left and right
tidydata<-dataset %>%
        filter(complete.cases(.)) %>% #remove incomplete cases
        select(c(defvar,uHfreq)) %>% #filter non interested freq
        mutate_at(uHfreq,as.numeric) %>% #convert to numeric
        pivot_longer(!defvar, names_to="freq", values_to= "dB") %>% #long format
        pivot_wider(names_from = Type, values_from = "dB") %>% #expand Type
        mutate(diff=Audiometer-uHear,
               ave=rowMeans(select(.,c("Audiometer","uHear")),na.rm=TRUE)) %>%
        mutate(freqAll="All",avediffAll=median(diff),
               lowerAll=quantile(diff,0.025),upperAll=quantile(diff,0.975)) %>%
        group_by(Ear,freq) %>% #find average diff, lower & upper for each ear and freq
        mutate(avediff = median(diff),
               lower=quantile(diff,0.025),
               upper=quantile(diff,0.975)) 
        #mutate(avediff = mean(diff),
        #       lower=mean(diff)- 1.96*sd(diff),
        #       upper=mean(diff)+ 1.96*sd(diff))

geom.text.size=5.5
theme.size=30
geom.point.size=4
xlim.upp = 60
xlim.low = -5
ylim.upp = 40
ylim.low = -40
set1clr<-brewer.pal(n = 9,"Set1")
dataupto2kHz<-tidydata %>% filter(!(freq=="4"|freq=="6"))
dataupfrom4kHz<-tidydata %>% filter(!(freq=="0.5"|freq=="1"|freq=="2"))

baplotOpts<-function(data,X,Y,color, #ggplot aes
                     fg.XY, #facet grid formula
                     hl.avediff, hl.upper, hl.lower, #hline for avediff, upper, lower
                     gt.avediff.x, gt.upper.x, gt.lower.x, #x coord for geomtext
                     geom.text.size,theme.size,geom.point.size,colorp,
                     xlim.low,xlim.upp,ylim.low,ylim.upp){
ggplot(data, aes(x = {{X}}, y = {{Y}}, color={{color}})) + 
        facet_grid(fg.XY) +
        geom_point(size=geom.point.size,alpha=0.5) +
        #average difference line
        geom_hline(aes(yintercept = {{hl.avediff}}), data, color=colorp[3]) +
        geom_text(aes(gt.avediff.x,{{hl.avediff}},
                      label = paste("M =",as.character(round({{hl.avediff}},2))), 
                        vjust = -0.5,hjust="right"), 
                color=set1clr[3],size=geom.text.size, 
                check_overlap = T) +
        geom_hline(aes(yintercept = {{hl.lower}}),data, 
                   color = colorp[3], linetype="dashed") +
        geom_text(aes(gt.lower.x,{{hl.lower}},
                        label = paste("2.5^{th}:",as.character(round({{hl.lower}},2))), 
                        vjust = 1.5,hjust="right"), 
                  color=colorp[3],size=geom.text.size,
                  check_overlap = T, parse = TRUE) +      
          geom_hline(aes(yintercept = {{hl.upper}}),data, 
                     color = colorp[3], linetype="dashed") +
          geom_text(aes(gt.upper.x,{{hl.upper}},
                        label = paste("97.5^{th}:",as.character(round({{hl.upper}},2))), 
                        vjust = -0.5,hjust="right"), size=geom.text.size,
                  color=colorp[3],check_overlap = T, parse = TRUE) +
        ylab(element_blank()) + xlab(element_blank()) + 
        xlim(xlim.low, xlim.upp) + ylim(ylim.low, ylim.upp) +
        scale_color_brewer(palette = "Set1") +
        theme(text = element_text(size=theme.size),legend.position="none",
              axis.title = element_blank())
}

plot1<-baplotOpts(data=dataupto2kHz, X=ave, Y=diff, color=Ear,
                  fg.XY = as.formula(Ear~freq),
                  hl.avediff = avediff, hl.upper = upper, hl.lower=lower,
                  gt.avediff.x=xlim.upp, gt.upper.x = xlim.upp, 
                  gt.lower.x = xlim.upp,
                  geom.text.size=5.5,theme.size=30,geom.point.size=4,
                  colorp = set1clr, xlim.low = xlim.low, xlim.upp = xlim.upp,
                  ylim.low = ylim.low, ylim.upp = ylim.upp)

plot2<-baplotOpts(data=dataupfrom4kHz, X=ave, Y=diff, color=Ear,
                  fg.XY = as.formula(Ear~freq),
                  hl.avediff = avediff, hl.upper = upper, hl.lower=lower,
                  gt.avediff.x=xlim.upp, gt.upper.x = xlim.upp, 
                  gt.lower.x = xlim.upp,
                  geom.text.size=5.5,theme.size=30,geom.point.size=4,
                  colorp = set1clr, xlim.low = xlim.low, xlim.upp = xlim.upp,
                  ylim.low = ylim.low, ylim.upp = ylim.upp) +
        theme(strip.text.y = element_blank())

plot3<-baplotOpts(data=tidydata, X=ave, Y=diff, color=Ear,
                  fg.XY = as.formula(Ear~freqAll),
                  hl.avediff = avediffAll, hl.upper = upperAll, hl.lower=lowerAll,
                  gt.avediff.x=xlim.upp, gt.upper.x = xlim.upp, 
                  gt.lower.x = xlim.upp,
                  geom.text.size=5.5,theme.size=30,geom.point.size=4,
                  colorp = set1clr, xlim.low = xlim.low, xlim.upp = xlim.upp,
                  ylim.low = ylim.low, ylim.upp = ylim.upp) + 
        theme(axis.text.y=element_blank(),axis.ticks.y=element_blank(),
              axis.ticks.length.y = unit(0, "pt"), 
              plot.margin = unit(c(0.2,0.2,0.2,0),"cm"))

grid.arrange(plot1,plot2,nrow=2,
             left=textGrob("Difference between PTA and uHear (dB HL)", rot = 90, gp = gpar(fontsize = theme.size)),
             bottom=textGrob("Arithmetic average between PTA and uHear (dB HL)", gp = gpar(fontsize = theme.size)))

#generate g for ggsave
g <- arrangeGrob(plot1, plot2, plot3,
                 widths = c(1, 1, 1), #equal widths in thirds
                 layout_matrix = rbind(c(1,1,1),
                                        c(2,2,3)),
             left=textGrob("Difference between PTA and uHear (dB HL)", rot = 90, gp = gpar(fontsize = theme.size)),
             bottom=textGrob("Arithmetic average between PTA and uHear (dB HL)", gp = gpar(fontsize = theme.size))) 
ggsave("BAPlot.svg",plot = g, width = 1500, height = 800, units = "px",scale = 5)
ggsave("BAPlot.pdf",plot = g, width = 1500, height = 1200, units = "px",scale = 3.5)

```

## Statistical analysis





